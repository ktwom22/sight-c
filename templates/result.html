<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üéØ SightCR Results</title>

<!-- Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8WQ2J22B9Z"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-8WQ2J22B9Z');
</script>

<style>
body { font-family: 'Segoe UI', Arial, sans-serif; background: #f5f6fa; color: #333; text-align: center; margin:0; padding:20px; }
h1 { font-size: 1.8em; margin-bottom: 15px; }
.result-box { background: #fff; max-width: 600px; margin: 0 auto 20px; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
.score { font-size: 1.5em; font-weight: 600; margin-bottom: 12px; }
.round-bars { font-size: 1.3em; margin-bottom: 10px; line-height: 1.5; }
.note { font-size: 0.85em; color: #777; margin-bottom: 12px; }
.copy-btn, .submit-btn, .freeplay-btn, .leaderboard-btn { margin-top: 10px; padding: 8px 20px; border-radius: 6px; font-size: 0.95em; cursor: pointer; border: none; font-weight: 500; }
.copy-btn { background: #3498db; color: #fff; }
.copy-btn:hover { background: #2980b9; }
.submit-btn { background: #1abc9c; color: #fff; }
.submit-btn:hover { background: #16a085; }
.freeplay-btn { background: #27ae60; color: #fff; }
.freeplay-btn:hover { background: #1e8449; }
.leaderboard-btn { background: #f39c12; color: #fff; }
.leaderboard-btn:hover { background: #d35400; }
input[type="email"] { padding: 6px; width: 65%; border-radius: 6px; border: 1px solid #ccc; font-size: 0.95em; }
.prompt { font-size: 0.9em; color: #555; margin-top: 8px; }
#leaderboard { background: #fff; max-width: 600px; margin: 20px auto; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); display: none; }
#leaderboard table { width: 100%; border-collapse: collapse; margin-top: 10px; }
#leaderboard th, #leaderboard td { padding: 6px 8px; font-size: 0.9em; }
#leaderboard th { background: #3498db; color: #fff; border-radius: 6px; }
#leaderboard tr.highlight { background: #d1f2eb; font-weight: 600; }
#result-map { width: 100%; max-width: 600px; height: 350px; margin: 20px auto; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
</style>
</head>
<body>

<h1>üèÅ Your Results</h1>

<div class="result-box">
    <div class="score">Total Score: {{ score }}</div>

    <div class="round-bars">
      {% for r in results %}
        {{ r.bar }} ({{ r.distance_km }} km)<br>
      {% endfor %}
    </div>

    <div class="note">Distance bars show how close your guesses were each round.</div>

    <!-- Google Map -->
    <div id="result-map"></div>

    <button class="copy-btn" onclick="copyShare()">üìã Copy Results</button>

    <div id="action-section">
      {% if not user_email %}
        <form method="POST" action="{{ url_for('result') }}">
          <div class="prompt">Want to unlock Free Play? Submit your score!</div>
          <input type="email" name="email" placeholder="Enter your email" required>
          <button type="submit" class="submit-btn">Submit</button>
        </form>
      {% elif freeplay_unlocked %}
        <button class="freeplay-btn" onclick="window.location.href='/freeplay'">üåç Free Play</button>
        <button class="leaderboard-btn" onclick="document.getElementById('leaderboard').style.display='block';">üèÜ Leaderboard</button>
      {% endif %}
    </div>
</div>

<!-- Leaderboard -->
<div id="leaderboard">
  <h2>üèÜ Daily Leaderboard</h2>
  <table>
    <tr>
      <th>Player</th>
      <th>Score</th>
    </tr>
    {% set user_display = user_email.split('@')[0] if user_email else "" %}
    {% for e in entries %}
      <tr {% if e.email.split('@')[0] == user_display %}class="highlight"{% endif %}>
        <td>{{ e.email.split('@')[0] }}</td>
        <td>{{ e.score }}</td>
      </tr>
    {% endfor %}
  </table>
  <button onclick="document.getElementById('leaderboard').style.display='none';">Close</button>
</div>

<textarea id="share-text" style="display:none;">
üåé SightCR Results
Total Score: {{ score }}
Check it out: https://sightcr.com
{% for r in results %}
{{ r.bar }} ({{ r.distance_km }} km)
{% endfor %}
</textarea>

<!-- Google Maps API -->
<script src="https://maps.googleapis.com/maps/api/js?key={{ api_key }}&callback=initResultMap" async defer></script>
<script>
function copyShare() {
    const shareText = document.getElementById('share-text').value;
    navigator.clipboard.writeText(shareText).then(() => { alert("‚úÖ Results copied to clipboard!"); });
}

// Auto-show leaderboard if email already submitted
{% if user_email %}
  document.getElementById('leaderboard').style.display = 'block';
{% endif %}

// Initialize Google Map
function initResultMap() {
  {% if results and results[0] %}
    const actualLat = {{ results[0].actual_lat }};
    const actualLng = {{ results[0].actual_lon }};
    const guessedLat = {{ results[0].guessed_lat }};
    const guessedLng = {{ results[0].guessed_lon }};

    const map = new google.maps.Map(document.getElementById('result-map'), {
      center: {lat: (actualLat + guessedLat)/2, lng: (actualLng + guessedLng)/2},
      zoom: 3
    });

    new google.maps.Marker({position:{lat:actualLat,lng:actualLng}, map, label:"A", title:"Actual Location"});
    new google.maps.Marker({position:{lat:guessedLat,lng:guessedLng}, map, label:"G", title:"Your Guess"});

    new google.maps.Polyline({
      path:[{lat:actualLat,lng:actualLng},{lat:guessedLat,lng:guessedLng}],
      geodesic:true,
      strokeColor:'#FF0000',
      strokeOpacity:0.8,
      strokeWeight:2,
      map:map
    });

    const bounds = new google.maps.LatLngBounds();
    bounds.extend({lat:actualLat, lng:actualLng});
    bounds.extend({lat:guessedLat, lng:guessedLng});
    map.fitBounds(bounds);
  {% endif %}
}
</script>
</body>
</html>
