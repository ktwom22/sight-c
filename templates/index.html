<!DOCTYPE html>
<html lang="en">
<head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8WQ2J22B9Z"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-8WQ2J22B9Z');
</script>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üåç SightCR - Street View Guessing Game</title>

<style>
html, body { margin:0; padding:0; height:100%; font-family:'Segoe UI', Arial, sans-serif; overflow:hidden; background:#f4f7fa; }

.game-container { position: relative; width:100%; height:100vh; }

header { position:absolute; top:10px; left:50%; transform:translateX(-50%); text-align:center; z-index:10; }
header h1 { margin:0; font-size:2rem; color:#2c3e50; }
header p { margin:5px 0; font-size:1.1rem; color:#555; }

#score-bubble {
  position:absolute; top:10px; right:20px;
  background:#fff; color:#3498db;
  padding:12px 20px; border-radius:50px;
  font-weight:bold; box-shadow:0 6px 15px rgba(0,0,0,0.2);
  font-size:1.1rem; z-index:10;
  transition: transform 0.2s;
}
#score-bubble.pop { transform:scale(1.3); }

#street-view { width:100%; height:100%; }

#map-container {
  position:fixed; bottom:0; left:0; width:100%;
  height:30px; max-height:50%; transition:height 0.3s ease;
  border-top:3px solid #28a745; border-radius:12px 12px 0 0; overflow:hidden;
  background:#fff; box-shadow:0 -2px 10px rgba(0,0,0,0.2); z-index:5;
}
#map-header { cursor:pointer; background:#28a745; color:#fff; padding:8px 12px; text-align:center; font-weight:bold; user-select:none; }
#map-arrow { display:inline-block; transition: transform 0.3s; }
#map { width:100%; height:calc(100% - 30px); }

#submit-btn {
  position:fixed; bottom:10px; left:50%; transform:translateX(-50%);
  padding:14px 30px; font-size:1.1rem; border-radius:50px; border:none;
  background:#28a745; color:white; cursor:pointer; display:none; z-index:10;
  box-shadow:0 6px 15px rgba(0,0,0,0.2); transition: transform 0.2s;
}
#submit-btn:disabled { background:#aaa; cursor:not-allowed; }
#submit-btn:hover:enabled { transform:scale(1.1); }

</style>
</head>

<body>
<div class="game-container">

  <!-- Score bubble -->
  <div id="score-bubble">Score: {{ score }}</div>

  <header>
    <h1>üåç SightCR</h1>
    {% if session.get('email') == 'admin@sightcr.com' %}
      <p><a href="/force_new_locations" style="color:red;font-weight:bold;text-decoration:none;">üîß Force New Locations</a></p>
    {% endif %}
  </header>

  <!-- Street View -->
  <div id="street-view" aria-label="Google Street View"></div>

  <!-- Collapsible map -->
  <div id="map-container">
    <div id="map-header"><span id="map-arrow">‚¨ÜÔ∏è</span> Click to Expand / Collapse Map</div>
    <div id="map"></div>
  </div>

  <!-- Hidden guess form -->
  <form method="POST" action="{{ url_for('guess') }}">
    <input type="hidden" name="lat" id="guess-lat">
    <input type="hidden" name="lon" id="guess-lon">
    <button type="submit" id="submit-btn" disabled>Submit Guess</button>
  </form>

</div>

<script src="https://maps.googleapis.com/maps/api/js?key={{ api_key }}"></script>
<script>
// Street View Panorama
var panorama = new google.maps.StreetViewPanorama(
  document.getElementById('street-view'), {
    position: {lat: {{ lat }}, lng: {{ lon }}},
    pov: {heading: {{ heading }}, pitch:0}, zoom:1,
    motionTracking:false, panControl:false, addressControl:false,
    fullscreenControl:false, linksControl:false, showRoadLabels:false
  });

// Map
var map = new google.maps.Map(document.getElementById('map'), {center:{lat:0,lng:0}, zoom:2});
var guessMarker = null;

map.addListener('click', function(event){
  if(guessMarker) guessMarker.setMap(null);
  guessMarker = new google.maps.Marker({position:event.latLng, map:map});
  document.getElementById('guess-lat').value = event.latLng.lat();
  document.getElementById('guess-lon').value = event.latLng.lng();
  var submitBtn = document.getElementById('submit-btn');
  submitBtn.disabled = false;
  submitBtn.style.display = 'block';
  // optional: animate score bubble pop
  var scoreBubble = document.getElementById('score-bubble');
  scoreBubble.classList.add('pop');
  setTimeout(()=>scoreBubble.classList.remove('pop'),200);
});

// Collapsible map
var mapContainer = document.getElementById('map-container');
var mapHeader = document.getElementById('map-header');
var mapArrow = document.getElementById('map-arrow');
var submitBtn = document.getElementById('submit-btn');
var collapsed = true;

mapHeader.addEventListener('click', function(){
  collapsed = !collapsed;
  mapContainer.style.height = collapsed ? '30px' : '40%';
  mapArrow.style.transform = collapsed ? 'rotate(0deg)' : 'rotate(180deg)';
  submitBtn.style.display = collapsed ? 'none' : 'block';
});
</script>
</body>
</html>
