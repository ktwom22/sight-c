<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Street View Guess</title>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-K0NCHYWJDB"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-K0NCHYWJDB');
</script>

<style>
/* Modal background */
#instructionsModal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  backdrop-filter: blur(4px);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}

/* Modal content */
#instructionsContent {
  background: white;
  border-radius: 16px;
  padding: 25px;
  max-width: 400px;
  width: 90%;
  text-align: left;
  box-shadow: 0 5px 20px rgba(0,0,0,0.3);
}

#instructionsContent h2 {
  text-align: center;
  margin-bottom: 15px;
}

#instructionsContent ul {
  padding-left: 20px;
}

#instructionsContent li {
  margin-bottom: 10px;
  line-height: 1.4;
}

#closeInstructions {
  display: block;
  margin: 20px auto 0;
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  background-color: #28a745;
  color: white;
  font-size: 16px;
  cursor: pointer;
}

#closeInstructions:hover {
  background-color: #218838;
}

body { font-family: Arial; text-align: center; background: #f4f4f4; margin:0; padding:0; }
#street-view, #map { width: 90%; height: 40vh; margin: 20px auto; border-radius: 12px; }
button { padding: 12px 25px; font-size: 16px; margin-top: 10px; border-radius: 6px; border: none; background-color: #28a745; color: white; cursor: pointer; }
button:hover { background-color: #218838; }
@media (max-width: 600px) { #street-view, #map { width: 95%; height: 35vh; } button { width: 90%; font-size: 14px; } }
</style>
</head>
<body>
<!-- Instructions Modal -->
<div id="instructionsModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
     background:rgba(0,0,0,0.7); justify-content:center; align-items:center; z-index:1000;">
  <div style="background:white; padding:30px; border-radius:10px; max-width:500px; text-align:center;">
    <h2>How to Play</h2>
    <p>Guess the location in Google Street View as close as possible. After 5 rounds, see your score and share results!</p>
    <button id="gotItBtn" style="padding:10px 20px; font-size:16px;">Got it!</button>
  </div>
</div>

<script>
  // Show modal if the backend tells us to
  const showInstructions = {{ 'true' if show_instructions else 'false' }};
  const modal = document.getElementById('instructionsModal');

  if(showInstructions){
      modal.style.display = 'flex';
  }

  document.getElementById('gotItBtn').addEventListener('click', () => {
      // Mark instructions as shown in session
      fetch('/instructions_shown', {method:'POST'})
          .then(() => {
              modal.style.display = 'none'; // hide modal
          });
  });
</script>
<h1>üåç Street View Guess</h1>
<p>Round {{ round }} | Score: {{ score }}</p>


<div id="street-view"></div>
<div id="map"></div>

<form method="POST" action="{{ url_for('guess') }}">
    <input type="hidden" name="lat" id="guess-lat">
    <input type="hidden" name="lon" id="guess-lon">
    <button type="submit" id="submit-btn" disabled>Submit Guess</button>
</form>

<script src="https://maps.googleapis.com/maps/api/js?key={{ api_key }}"></script>
<script>
var panorama = new google.maps.StreetViewPanorama(
    document.getElementById('street-view'), {
        position: {lat: {{ lat }}, lng: {{ lon }}},
        pov: {heading: {{ heading }}, pitch: 0},
        zoom: 1,
        motionTracking: false,
        panControl: false,
        addressControl: false,
        fullscreenControl: false,
        linksControl: false,
        showRoadLabels: false
    });

var map = new google.maps.Map(document.getElementById('map'), { center: {lat: 0, lng: 0}, zoom: 2 });
var guessMarker = null;

map.addListener('click', function(event) {
    if (guessMarker) guessMarker.setMap(null);
    guessMarker = new google.maps.Marker({ position: event.latLng, map: map });
    document.getElementById('guess-lat').value = event.latLng.lat();
    document.getElementById('guess-lon').value = event.latLng.lng();
    document.getElementById('submit-btn').disabled = false;
});
</script>
</body>
</html>
